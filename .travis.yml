language: node_js
node_js:
  - 12

env:
  - AWS_USER_ID="922803931776" AWS_ECR_API="922803931776.dkr.ecr.us-east-1.amazonaws.com/iic2173-proyecto-semestral-grupo-8"
services:
  - docker
branches:
    only:
        - master

before_install:
  - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" 
  - unzip awscliv2.zip
  - sudo ./aws/install
  - sudo curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - sudo chmod +x /usr/local/bin/docker-compose
  - docker-compose --version

script:
  - zip -r latest *
  - mkdir -p dpl_cd_upload
  - mv latest.zip dpl_cd_upload/latest.zip


deploy:
  - provider: s3
    access_key_id: ${AWS_ACCESS_KEY_ID}
    secret_access_key: ${AWS_SECRET_ACCESS_KEY}
    local_dir: dpl_cd_upload
    skip_cleanup: true
    bucket: "chatapp-backend-bucket"
    region: us-east-1
    upload-dir: latest
    on:
      master: true

  - provider: codedeploy
    access_key_id: ${AWS_ACCESS_KEY_ID}
    secret_access_key: ${AWS_SECRET_ACCESS_KEY}
    bucket: "chatapp-backend-bucket"
    key: latest/latest.zip
    bundle_type: zip
    application: ChatApp-backend
    deployment_group: ChatApp-backend
    region: us-east-1
    wait_until_deployed: true
    on:
      branch: master
